<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4C56GQP4ZL');
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <title>HEU人最后的倔强 ver.Liquid</title>
    <link rel="icon" href="./favicon.ico">
    <link rel="shortcut icon" href="./favicon.ico">
    <link rel="stylesheet" href="./css/liquid.css">
    <link rel="preload" href="./DINCond-Bold.otf" as="font" type="font/otf" crossorigin>
    
    <!-- 核心样式补丁 -->
    <style>
        /* =========================================
           iOS 移动端布局专项修复 (Ver 2.0)
           ========================================= */

        /* 1. 样式选择框修复 */
        .flex-group select {
            flex: 0 1 auto !important;
            width: fit-content !important;
            min-width: 60px;
            max-width: 65%;
            padding-right: 25px !important;
        }
        
        .flex-group button {
            flex-shrink: 0 !important;
            white-space: nowrap;
        }

        /* 2. 标题输入框修复 */
        .input-with-prefix {
            display: inline-flex !important;
            width: auto !important;
            flex-wrap: nowrap !important;
        }

        /* 3. 时间/日期小输入框专项修复 */
        .time-inp, .year-inp, .date-inp, .mini-input, #inpt_temperature, #inpt_humidity {
            padding: 0 2px !important;
            min-width: 25px !important;
            text-align: center !important;
            width: auto;
        }
        .year-inp {
            min-width: 40px !important;
        }

        /* 4. 极致紧凑布局修复 (缩减标签空隙) */
        .setDataList li {
            gap: 4px !important;
            justify-content: flex-start;
        }

        .setDataList li label {
            min-width: 0 !important;
            width: auto !important;
            flex: 0 0 auto !important;
            margin-right: 2px !important;
            text-align: right;
        }

        .input-with-prefix {
            gap: 2px !important;
        }
        
        .prefix {
            margin-right: 0 !important;
            padding-right: 2px !important;
        }

        /* 5. 强制里程与配速输入框文字居中 */
        #inpt_miles,
        #inpt_speeds,
        #inpt_savePic_width,
        .mile2-inp {
            text-align: center !important;
            padding: 0 5px !important;
        }

        .range-input {
            text-align: center !important;
        }
        
        .input-with-prefix input {
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
            width: auto;
            min-width: 80px !important;
        }
    </style>
</head>

<body id="body">

    <!-- 动态背景层 -->
    <div class="liquid-bg-gradient"></div>
    <div class="liquid-orb orb-1"></div>
    <div class="liquid-orb orb-2"></div>

    <div id="main-div">
        <!-- 左侧：手机预览 -->
        <div id="new-Img" class="new-img glass-effect">
            <div class="bgimgwrap" id="bgimgwrap">
                <img src="" class="innerbgimg" id="bg-img" alt="" />
            </div>
            <img src="" id="gui-img" alt="" />
            <div class="portrait-wrap" id="portrait-wrap">
                <img class="portrait" id="portrait" src="" alt="" />
            </div>
            <div class="weather-imgwrap">
                <img src="" class="weather" id="weather" alt="" />
            </div>
            <span class="username" id="username">UserName</span>
            <span class="keep-title" id="keep-title">户外跑步</span>
            <span class="mile"><span id="mile" class="mile-data">0.00</span><span class="gongli">公里</span></span>
            <span class="datetime date" id="date">0000/00/00</span>
            <span class="datetime time" id="time">00:00</span>
            <span class="env temperature" id="temperature">00</span>
            <span class="env humidity" id="humidity">00</span>
            <span class="speed-time speed" id="speed">00'00"</span>
            <span class="speed-time cost-time" id="cost-time">00:00:00</span>
            <span class="speed-time calorie" id="calorie">0</span>
        </div>

        <!-- 右侧：控制面板 -->
        <div class="set-data">
            <div id="messageBox"></div>

            <!-- 导出控制区 -->
            <div class="glass-card export-panel">
                <div class="export-grid">
                    <button onclick="Download(Download1)" class="btn-primary main-save">
                        <span class="icon"></span> 保存高清图片
                    </button>
                    <button onclick="Download(Download2)" class="btn-secondary main-preview">
                        <span class="icon"></span> 预览
                    </button>
                    <button onclick="Download(Download3)" class="btn-tiny backup-btn">备用方案 A</button>
                </div>
            </div>

            <!-- 主设置面板 -->
            <div class="glass-card control-panel">
                <ul class="setDataList">
                    <!-- 用户信息 -->
                    <div class="input-group">
                        <div class="group-title">基本信息</div>
                        <li>
                            <label>用户名</label>
                            <input id="inpt_username" onchange="setData()" type="text" placeholder="输入昵称">
                        </li>
                        <li>
                            <label>头像</label>
                            <div class="file-action-row">
                                <button onclick="inpt_portrait_onClick()" class="btn-small">上传</button>
                                <button onclick="init_portrait()" class="btn-text">恢复默认</button>
                                <input style="display:none;" type="file" accept="image/*" id="inpt_portrait" onchange="portrait_inpt()" />
                            </div>
                        </li>
                        <li>
                            <label>标题</label>
                            <div class="input-with-prefix">
                                <span class="prefix">keep • </span>
                                <input id="inpt_keep_title" onchange="setData()" type="text" placeholder="户外跑步">
                            </div>
                        </li>
                    </div>

                    <!-- 运动数据 -->
                    <div class="input-group">
                        <div class="group-title">运动数据</div>
                        <li>
                            <label>里程</label>
                            <input id="inpt_miles" onchange="setData()" type="text" class="font-mono" placeholder="0.00">
                        </li>
                        <div class="sub-setting">
                            <span class="sub-label">随机范围:</span>
                            <input type="text" id="min_miles" onchange="set_km_and_speed()" class="mini-input" placeholder="Min">
                            <span class="dash">-</span>
                            <input type="text" id="max_miles" onchange="set_km_and_speed()" class="mini-input" placeholder="Max">
                        </div>

                        <li style="margin-top: 12px;">
                            <label>配速</label>
                            <input id="inpt_speeds" onchange="setData()" type="text" class="font-mono" placeholder="5'30&quot;">
                        </li>
                        <div class="sub-setting">
                            <span class="sub-label">随机范围:</span>
                            <input type="text" id="min_speeds" onchange="set_km_and_speed()" class="mini-input" placeholder="快">
                            <span class="dash">-</span>
                            <input type="text" id="max_speeds" onchange="set_km_and_speed()" class="mini-input" placeholder="慢">
                        </div>
                    </div>

                    <!-- 时间与环境 -->
                    <div class="input-group">
                        <div class="group-title">时间与环境</div>
                        <li>
                            <label>时间</label>
                            <div class="datetime-row">
                                <input id="inpt_year" onchange="setData()" type="text" class="year-inp"><span>/</span>
                                <input id="inpt_month" onchange="setData()" type="text" class="date-inp"><span>/</span>
                                <input id="inpt_day" onchange="setData()" type="text" class="date-inp">
                                <span class="spacer"></span>
                                <input id="inpt_hour" onchange="setData()" type="text" class="time-inp"><span>:</span>
                                <input id="inpt_min" onchange="setData()" type="text" class="time-inp">
                            </div>
                        </li>
                        <li>
                            <label>天气</label>
                            <select onchange="weather_Select_onChange()" id="weather_Select">
                                <option value="images/weather1.png">晴</option>
                                <option value="images/weather2.png">多云</option>
                                <option value="images/weather3.png">阴天</option>
                            </select>
                        </li>
                        <li>
                            <label>温湿度</label>
                            <div class="dual-input">
                                <input id="inpt_temperature" onchange="setData()" type="text" class="mini-input" placeholder="°C">
                                <span class="unit">°C</span>
                                <input id="inpt_humidity" onchange="setData()" type="text" class="mini-input" placeholder="%">
                                <span class="unit"></span>
                            </div>
                        </li>
                    </div>

                    <!-- 地图与轨迹 -->
                    <div class="input-group">
                        <div class="group-title">地图与轨迹</div>
                        <li>
                            <label>背景</label>
                            <select onchange="default_bgImgSelect_onChange()" id="default_bgImgSelect">
                                <option value="guiji_Select_1">南体育场</option>
                                <option value="guiji_Select_2">军工操场</option>
                                <option value="guiji_Select_3">北体育场</option>
                            </select>
                        </li>
                        <li>
                            <label>自定义</label>
                            <div class="file-action-row">
                                <button onclick="inpt_bgimg_onClick()" class="btn-small">上传地图</button>
                                <button onclick="init_bgimg()" class="btn-text">重置</button>
                                <input style="display:none;" type="file" accept="image/*" id="inpt_bgimg" onchange="bgimg_inpt()" />
                            </div>
                        </li>

                        <li>
                            <label>样式</label>
                            <div class="flex-group" style="display:flex; gap:8px; align-items:center; flex:1;">
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_1" class="guijiSelect">
                                    <option value="['images/bg1_1.png', 'images/bg1_empty2.png']">样式 1</option>
                                    <option value="['images/bg1_2.png', 'images/bg1_empty2.png']">样式 2</option>
                                    <option value="['images/bg1_3.png', 'images/bg1_empty2.png']">样式 3</option>
                                    <option value="['images/bg1_4.png', 'images/bg1_empty2.png']">样式 4</option>
                                    <option value="['images/bg1_5.png', 'images/bg1_empty2.png']">样式 5</option>
                                    <option value="['images/bg1_empty2.png', 'images/bg1_empty2.png']">默认</option>
                                </select>
                                <button onclick="drawMine()" class="btn-small btn-secondary" title="生成随机路径">随机</button>
                                <!-- 隐藏的备用 Select -->
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_2" class="guijiSelect" style="display:none;">
                                    <option value="['images/bg2_empty.png', 'images/bg2_empty.png']">默认</option>
                                </select>
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_3" class="guijiSelect" style="display:none;">
                                    <option value="['images/bg3_empty.png', 'images/bg3_empty.png']">默认</option>
                                </select>
                            </div>
                        </li>

                        <!--
                           已移除 "自动生成" 和 "渐变色" 的复选框
                           (注意：如果 JS 中仍需用到这些参数，建议保留输入框ID但隐藏，这里仅移除了Switch开关)
                        -->
                        
                        <div class="sub-setting" id="bs_prop_inpt_wrap">
                            <span class="sub-label">变色概率:</span>
                            <input id="inpt_bs_prob" onchange="setData()" type="text" class="mini-input" placeholder="0.5">
                        </div>
                        <div class="sub-setting" id="inpt_bs_range_wrap">
                            <span class="sub-label">变色步长:</span>
                            <input id="inpt_bs_range_min" onchange="setData()" type="text" class="mini-input">
                            <span class="dash">-</span>
                            <input id="inpt_bs_range_max" onchange="setData()" type="text" class="mini-input">
                        </div>
                    </div>

                    <!-- 输出设置 (尺寸 + 文件名) -->
                    <div class="input-group no-border">
                        <li>
                            <label>宽度</label>
                            <input id="inpt_savePic_width" onchange="setData()" type="text" placeholder="默认" style="min-width:80px;">
                            <span class="unit">px</span>
                        </li>
                        <!-- ✅ 新增：文件名设置 -->
                        <li>
                            <label>文件名</label>
                            <div style="display:flex; align-items:center; gap:10px; flex:1;">
                                <div class="switch-item" style="margin:0;">
                                    <input type="checkbox" id="chk_default_filename" checked onchange="toggleFilenameInput()">
                                    <span style="white-space:nowrap; font-size:13px;">默认</span>
                                </div>
                                <input type="text" id="inpt_custom_filename" placeholder="输入文件名 (无需后缀)" style="display:none; flex:1; min-width:0;">
                            </div>
                        </li>
                    </div>

                </ul>

                <div class="divider"></div>
                <div class="system-actions">
                    <button onclick="storeToIndexedDB(tmp_portrait_src,tmp_bgimg_osrc)" class="btn-text">保存配置</button>
                    <button onclick="clearIndexedDB()" class="btn-text btn-danger-text">重置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS 引用 -->
    <script src="js/invoke/html2canvas.min.js" defer></script>
    <script src="js/invoke/amapHelper.js" defer></script>
    <script src="js/indexedDB.js" defer></script>
    <script src="js/init.js" defer></script>
    <script src="js/render.js" defer></script>
    <script src="js/select_manner.js" defer></script>
    <script src="js/dataURLtoBlob.js" defer></script>
    <script src="js/img_both_inpt_set.js" defer></script>
    <script src="js/draw_personalization.js" defer></script>
    <script src="js/download_img.js" defer></script>
    <script src="js/localTrackGen.js"></script>
    <script src="js/drawMine.js" defer></script>
    <script src="js/onload.js" defer></script>

    <!-- ✅ 最终功能脚本：包含文件名逻辑 + 自动运行 + 离屏生成 + 宽度自适应 -->
    <script>
        // 1. 文件名输入框切换逻辑
        function toggleFilenameInput() {
            const isDefault = document.getElementById('chk_default_filename').checked;
            const input = document.getElementById('inpt_custom_filename');
            input.style.display = isDefault ? 'none' : 'block';
            if (!isDefault) setTimeout(() => input.focus(), 100);
        }

        // 2. 修复 iOS 字体和宽度
        function getCanvasFont(elem) {
            const style = window.getComputedStyle(elem);
            return `${style.fontWeight || 'normal'} ${style.fontSize || '14px'} ${style.fontFamily || 'sans-serif'}`;
        }

        function adjustInputWidth(elem) {
            let canvas = adjustInputWidth.canvas || (adjustInputWidth.canvas = document.createElement("canvas"));
            let ctx = canvas.getContext("2d");
            ctx.font = getCanvasFont(elem);
            let text = elem.value || elem.placeholder || "";
            let metrics = ctx.measureText(text);
            
            const isMini = ['time-inp', 'year-inp', 'date-inp', 'mini-input'].some(c => elem.classList.contains(c)) ||
                           ['inpt_temperature', 'inpt_humidity'].includes(elem.id);
            
            elem.style.width = (Math.ceil(metrics.width) + (isMini ? 15 : 35)) + "px";
        }

        function initAutoWidth() {
            document.querySelectorAll('input[type="text"]').forEach(input => {
                adjustInputWidth(input);
                input.addEventListener('input', function() { adjustInputWidth(this); });
                input.addEventListener('blur', function() { adjustInputWidth(this); });
            });
        }

        // 3. 主逻辑初始化
        window.addEventListener('load', function() {
            console.log("System Ready: Auto-path (Forced) & Custom Filename loaded.");

            // === 功能 1：强制默认生成随机路径 (无需复选框) ===
            setTimeout(() => {
                if (typeof drawMine === 'function') {
                    console.log("Auto-generating initial track...");
                    // 调用生成接口
                    drawMine();
                }
            }, 500); // 延迟500ms等待地图资源加载

            // 初始化宽度自适应
            initAutoWidth();
            
            // 劫持 API 赋值 (确保自动填入的数据能撑开宽度)
            ['inpt_temperature', 'inpt_humidity', 'inpt_keep_title', 'inpt_username', 'inpt_year', 'inpt_month', 'inpt_day', 'inpt_hour', 'inpt_min'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    const descriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
                    Object.defineProperty(el, 'value', {
                        get: function() { return descriptor.get.call(this); },
                        set: function(v) { descriptor.set.call(this, v); adjustInputWidth(this); }
                    });
                }
            });

            // === 核心：重写下载函数 (支持自定义文件名 & 离屏渲染) ===
            window.Download = function(fileNameArg) {
                const targetNode = document.getElementById('new-Img');
                if (!targetNode) return;

                // 创建幽灵容器 (避免视觉干扰)
                const ghostWrapper = document.createElement('div');
                Object.assign(ghostWrapper.style, {
                    position: 'fixed', top: '-9999px', left: '-9999px', zIndex: '-1000',
                    width: targetNode.offsetWidth + 'px'
                });
                document.body.appendChild(ghostWrapper);

                // 克隆节点
                const clonedNode = targetNode.cloneNode(true);
                
                // 手动重绘 Canvas
                const originalCanvases = targetNode.querySelectorAll('canvas');
                const clonedCanvases = clonedNode.querySelectorAll('canvas');
                originalCanvases.forEach((orig, index) => {
                    if (clonedCanvases[index]) {
                        clonedCanvases[index].width = orig.width;
                        clonedCanvases[index].height = orig.height;
                        clonedCanvases[index].getContext('2d').drawImage(orig, 0, 0);
                    }
                });

                // 移除干扰样式
                clonedNode.style.transform = 'none';
                clonedNode.style.boxShadow = 'none';
                clonedNode.style.margin = '0';
                
                ghostWrapper.appendChild(clonedNode);

                // === 功能 2：处理文件名逻辑 ===
                let finalFileName;
                const chkDefault = document.getElementById('chk_default_filename');
                const isDefaultName = chkDefault ? chkDefault.checked : true; // 防御性编程
                
                if (isDefaultName) {
                    // 逻辑 A: 使用默认逻辑
                    finalFileName = "HEU_Run_" + new Date().toISOString().slice(0,10);
                    if (typeof fileNameArg === 'string') finalFileName = fileNameArg;
                } else {
                    // 逻辑 B: 使用自定义输入框
                    const customInput = document.getElementById('inpt_custom_filename');
                    finalFileName = customInput.value.trim() || ("HEU_Run_" + new Date().toISOString().slice(0,10));
                }

                // 确保后缀
                if (!finalFileName.endsWith('.png')) finalFileName += '.png';

                // 生成图片
                html2canvas(clonedNode, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: null,
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = finalFileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    document.body.removeChild(ghostWrapper);
                    console.log(`Saved as: ${finalFileName}`);
                }).catch(err => {
                    console.error("Export failed:", err);
                    alert("生成失败，请重试");
                    if (document.body.contains(ghostWrapper)) document.body.removeChild(ghostWrapper);
                });
            };
        });
    </script>
</body>
</html>
